<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vastra Tara | Online Store</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/store.css') }}" rel="stylesheet">
</head>

<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">Vastra Tara</a>

        <!-- SEARCH -->
        <form class="d-flex mx-auto w-50" method="get" action="/">
            <input class="form-control me-2"
                   type="search"
                   name="search"
                   placeholder="Search for products">
            <button class="btn btn-light">Search</button>
        </form>

        <a href="/cart" class="btn btn-warning fw-bold">
            ðŸ›’ Cart
        </a>
    </div>
</nav>

<!-- PRODUCTS -->
<div class="container mt-4">

    <h5 class="mb-3 fw-bold">Top Picks for You</h5>

    {% if products %}
    <div class="row g-4">

        {% for p in products %}
        <div class="col-lg-3 col-md-4 col-sm-6">
            <div class="card product-card h-100 shadow-sm">

                <!-- IMAGE -->
                {% if p[3] %}
                    <img src="{{ url_for('static', filename='images/' + p[3]) }}"
                         class="product-img">
                {% else %}
                    <img src="{{ url_for('static', filename='images/no-image.png') }}"
                         class="product-img">
                {% endif %}

                <!-- CARD BODY -->
                <div class="card-body text-center d-flex flex-column">
                    <p class="product-title mb-1">{{ p[1] }}</p>
                    <p class="product-price fw-bold text-success mb-3">
                        â‚¹ {{ p[2] }}
                    </p>

                    <!-- BUTTONS -->
                    <div class="mt-auto d-grid gap-2">

                        <!-- ADD TO CART -->
                        <button class="btn btn-dark"
                                onclick="handleAddToCart({{ p[0] }})">
                            Add to Cart
                        </button>

                        <!-- BUY NOW -->
                        <a href="/product/{{ p[0] }}"
                           class="btn btn-outline-dark">
                            Buy Now
                        </a>

                    </div>
                </div>

            </div>
        </div>
        {% endfor %}

    </div>
    {% else %}
        <div class="text-center text-muted mt-5">
            <h5>No products found</h5>
        </div>
    {% endif %}

</div>

<!-- COLOUR SELECTION MODAL -->
<div class="modal fade" id="colourModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" action="/add_to_cart" class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Select Colour</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="colourOptions"></div>

      <input type="hidden" name="product_id" id="modalProductId">

      <div class="modal-footer">
        <button class="btn btn-dark">Add to Cart</button>
      </div>

    </form>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const productColours = {{ product_colours | tojson }};

function handleAddToCart(productId) {
    const colours = productColours[productId];

    // If only one colour â†’ auto add
    if (!colours || colours.length === 1) {
        submitAddToCart(productId, colours ? colours[0] : null);
        return;
    }

    // Multiple colours â†’ show modal
    document.getElementById("modalProductId").value = productId;

    let html = "";
    colours.forEach(c => {
        html += `
            <div class="form-check">
                <input class="form-check-input" type="radio"
                       name="colour" value="${c}" required>
                <label class="form-check-label">${c}</label>
            </div>
        `;
    });

    document.getElementById("colourOptions").innerHTML = html;
    new bootstrap.Modal(document.getElementById("colourModal")).show();
}

function submitAddToCart(productId, colour) {
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "/add_to_cart";

    form.innerHTML = `
        <input type="hidden" name="product_id" value="${productId}">
        <input type="hidden" name="colour" value="${colour}">
    `;

    document.body.appendChild(form);
    form.submit();
}
</script>

</body>
</html>
